1:"$Sreact.fragment"
4:I[25151,["/_next/static/chunks/cc5639b053815f24.js","/_next/static/chunks/4904848246fadb45.js"],"OutletBoundary"]
5:"$Sreact.suspense"
2:T1286,<p>今まで VSCode の <code>Generate Unit Tests For Function</code> で作成してなんとなくで書いてたけどちゃんと勉強した。</p>
<p><a href="https://github.com/andmorefine/learn-go-with-tests">https://github.com/andmorefine/learn-go-with-tests</a> を使って勉強した。日本語訳が微妙だったので英語版がよかった。</p>
<p>以下メモ。</p>
<ul>
<li><code>t.Helper()</code> を使えば失敗した行が関数呼び出し側になる</li>
<li>Benchmark 実行には <code>go test -bench=.</code> を実行する</li>
<li>カバレッジを確認するには <code>go test -cover</code> を実行する</li>
<li>スライスの test は <code>reflect.DeepEqual</code> を使って変数を比較する(型安全ではないので注意)。</li>
<li>マップは nil に書き込もうとするとランタイムパニックになるので初期化に気をつける
<ul>
<li>NG: <code>var m map[string]string</code></li>
<li>OK: <code>var dictonary = map[string]string{}</code> もしくは <code>var dictonary = make(map[string]string)</code></li>
</ul>
</li>
<li>標準ライブラリに <code>net/http/httptest</code> があってこれで模擬 HTTP サーバを作れる</li>
<li>'入力 X のとき出力 Y を期待する' というテストを作るときはテーブルベースのテストを使う</li>
</ul>
<h2>setup / teardown</h2>
<p>テストを行う際に、前処理と後処理を書きたい場合がある。</p>
<p>その場合は、<code>TestMain</code> を実装する。</p>
<pre><code class="hljs language-go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
	<span class="hljs-string">"log"</span>
	<span class="hljs-string">"os"</span>
	<span class="hljs-string">"testing"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestMain</span><span class="hljs-params">(m *testing.M)</span></span> {
	log.Println(<span class="hljs-string">"Before"</span>)
	ret := m.Run()
	log.Println(<span class="hljs-string">"After"</span>)
	os.Exit(ret)
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Test_A</span><span class="hljs-params">(t *testing.T)</span></span> {
	log.Println(<span class="hljs-string">"Test_A running"</span>)
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Test_B</span><span class="hljs-params">(t *testing.T)</span></span> {
	log.Println(<span class="hljs-string">"Test_B running"</span>)
}

<span class="hljs-comment">// 2024/08/14 15:40:10 Before</span>
<span class="hljs-comment">// 2024/08/14 15:40:10 Test_A running</span>
<span class="hljs-comment">// 2024/08/14 15:40:10 Test_B running</span>
<span class="hljs-comment">// PASS</span>
<span class="hljs-comment">// 2024/08/14 15:40:10 After</span>
</code></pre>
<p>TestMain では、<code>testing.M</code> を引数に取る必要がある。</p>
<p>前処理と後処理の最中にエラーが発生した場合には、<code>os.Exit</code> で以上終了したことを伝える必要がある。
終了コード「0」以外で終了する場合は、<code>log.Fatalf</code> を使うと便利。</p>
<pre><code class="hljs language-go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestMain</span><span class="hljs-params">(m *testing.M)</span></span> {
  <span class="hljs-keyword">if</span> err := setup(); err != <span class="hljs-literal">nil</span> {
    log.Fatalf(<span class="hljs-string">"failed to setup: "</span>, err)
  }

	ret := m.Run()

  <span class="hljs-keyword">if</span> err := teardown(); err != <span class="hljs-literal">nil</span> {
    log.Fatalf(<span class="hljs-string">"failed to teardown: "</span>, err)
  }

	os.Exit(ret)
}
</code></pre>
<h2>カバレッジ</h2>
<p>テストの進捗を示す指標としてカバレッジがある。</p>
<p>テストを実行した際に、テスト対象のプログラムが、テストによりどれくらいパスしたかを網羅率という数値で表す。</p>
<pre><code class="hljs language-bash">$ go <span class="hljs-built_in">test</span> -cover
</code></pre>
<p>また、どこのテストが実施されていないかを知るためには、<code>cover</code> プロファイルというファイルを生成する必要がある。</p>
<pre><code class="hljs language-bash">$ go <span class="hljs-built_in">test</span> -coverprofile=cover.out
</code></pre>
<p>このままのファイルでは見にくいので、ブラウザ上で見られるように変換する。</p>
<pre><code class="hljs language-bash">$ go tool cover -html=cover.out -o cover.html
</code></pre>0:{"buildId":"QRjg6Z3YyASrzbC3YDNw_","rsc":["$","$1","c",{"children":[["$","article",null,{"style":{"maxWidth":"1000px","margin":"0 auto","padding":"0 2rem 2rem"},"children":[["$","h1",null,{"children":"Goのテストを勉強する"}],["$","div",null,{"dangerouslySetInnerHTML":{"__html":"$2"}}]]}],null,"$L3"]}],"loading":null,"isPartial":false}
3:["$","$L4",null,{"children":["$","$5",null,{"name":"Next.MetadataOutlet","children":"$@6"}]}]
6:null
